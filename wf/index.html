<!DOCTYPE html>
<html>
<head>
	<title>Verificador de Atualização de suas páginas no Facebook</title>
	<!-- <script src ='js/jquery.js'></script> -->
	<script src="js/moment.js"></script>
	<script src='js/code.js'></script>
	<link rel="stylesheet" type="text/css" href="css/style.css">
	<script>

	function mountPage(u){
		//get All ids and create div's
		
		var div_pag = document.getElementById('div_pag');
		
		var k=[];
		for (v in u) {
		  if (u.hasOwnProperty(v)) {
		    k.push(v);
		  }
		}

		k.sort();
		
		div_pag.removeChild(document.getElementById('span_carregando'));
		for (var i=0;i<k.length;i++){
			var id =k[i];
			var name = u[id].name;
			var created_time = u[id].created_time;
			var last_updated = u[id].last_updated;
			var arrTime = u[id].arrTime;
			var message = u[id].message;
			var id_message = u[id].id_message;
			var seconds_last_update = u[id].seconds_last_update;

			//now let's build it!

			var div = document.createElement('div');
			var h3 = document.createElement('h3');
			var p_message = document.createElement('p');
			var span_time_updated = document.createElement('span');
			var span_time_passed = document.createElement('span');
			
			h3.innerHTML = name;
			if (message == undefined){
				message = "Nenhum texto. (um compartilhamento ou RT, talvez?";
			}
			p_message.innerHTML= "Texto do post: "+message;
			span_time_updated.innerHTML = "Ultimo update: "+(new Date(last_updated)).toLocaleDateString('pt-BR')+"<br>";
			span_time_passed.innerHTML = arrTime[0]+" dias, "+arrTime[1]+" horas, "+arrTime[2]+" minutos e "+arrTime[3]+"segundo(s) atrás.";

			//addClasses
			if(parseInt(arrTime[0])==0 && parseInt(arrTime[1])<=12){
				div.setAttribute('class','green updates');
			}else{
				if(parseInt(arrTime[0])==0 && parseInt(arrTime[1])>12 && parseInt(arrTime[1])<=24){
					div.setAttribute('class','yellow updates');
				}else{
					if(parseInt(arrTime[0])>0){
						div.setAttribute('class','red updates');
					}					
				}
			}
			div.appendChild(h3);
			div.appendChild(p_message);
			div.appendChild(span_time_updated);
			div.appendChild(span_time_passed);
			div_pag.appendChild(div);
		}		
	}
		var updates = [];

		var rs;
		function processResult(rs){
			var json =JSON.parse(rs);
			console.log(json);
			var keys = Object.keys(json);
			keys.sort();
			for(var i=0;i<keys.length;i++){
				console.log(keys[i]);
				var id = keys[i];
				var data = json[id].data[0];

				var last_updated = data.created_time;				
				var arrTime = getDaysPassed(last_updated);
				updates[id]['last_updated']=last_updated;
				updates[id]['arrTime']= arrTime;
				console.log(arrTime);
				updates[id]['id_message']= data.id;
				if(data.message==undefined){
					updates[id]['message']=data.story;
				}else{
					updates[id]['message']=data.message;
				}

			}
		}
		function doPostsRequest(up){
			
			 FB.api("/",'POST',{batch:[
			 						  {"method":"GET", "relative_url":"me/accounts","name":"get_page_ids"},
			 						  {'method':'GET','relative_url':"posts/?ids={result=get_page_ids:data.*.id}&limit=1",'depends_on':'get_page_ids'}]},
			 						  function(response){

			 						  	processResult(response[1].body);
			 						  	mountPage(up);
			 						  });
		}

		var ids = [];
		function getPages(){
			FB.api('/me/accounts',function(response){
					for (var i = 0;i<response.data.length;i++){
						var id = response.data[i].id;
						var name = response.data[i].name;	
						updates[String(id)]={'name':name};
					}
					doPostsRequest(updates);
			});
		}

		function testLogin(){
			FB.getLoginStatus(function(r){
				if(r.status=='connected'){
					document.getElementById("divLogado").setAttribute('style','display:block');
					console.log('Opa, vejamos os últimos updates...s ');
					FB.api('/me', function(response) {
						
						document.getElementById("divLogado").innerHTML= 'Bom te ver, ' + response.name + '.';
						getPages();
					});
					
				}else{
					console.log("entrou aqui");
					document.getElementById("precisa_logar").setAttribute('style','display:block');
				}
			});
		}	

	window.onload = function(){

		window.fbAsyncInit = function() {
			FB.init({
				// appId            : '799075846938489',
				appId:'344601849315421',
				autoLogAppEvents : true,
				xfbml            : true,
				version          : 'v2.10',
				channelUrl: 'http://cslaviero.github.io/wf/channel.html'
			});
			FB.AppEvents.logPageView();
			testLogin();
		};

		(function(d, s, id){
			var js, fjs = d.getElementsByTagName(s)[0];
			if (d.getElementById(id)) {return;}
			js = d.createElement(s); js.id = id;
			js.src = "http://connect.facebook.net/en_US/sdk.js";
			fjs.parentNode.insertBefore(js, fjs);
		}(document, 'script', 'facebook-jssdk'));

	}

	function success(response){
		if (response.authResponse) {
			console.log('Welcome!  Fetching your information.... ');
			FB.api('/me', function(response) {
				console.log('Bom te ver, ' + response.name + '.');

				document.getElementById("precisa_logar").setAttribute('style','display:none');
				getPages();
			});
		} else {
			console.log('User cancelled login or did not fully authorize.');
		}
	}

	// Only works after `FB.init` is called
		function myFacebookLogin() {
		  FB.login(success, {scope: 'manage_pages,pages_show_list'});

		  
		}
</script>

</head>
<body>
	
	<h1 id='title'>The FB update checker</h1>
	<span>v.002</span><br><br>
	<div id='precisa_logar' style='display:none' >
	<span>Xi, parece que você precisa logar antes...</span>
	<button id='botaoLogin' onclick="myFacebookLogin()">Logar no Facebook</button>
	</div>

	<div id='divLogado' style='display:none'> </div>
	<div id='div_pag'><h2>Suas páginas:</h2> <span id='span_carregando'>Aguarde, carregando...</span> </div>
	<div id="fb-root"></div>


</body>
</html>